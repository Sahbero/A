<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>HALKA — Tarayıcı Oyunu</title>
<style>
  :root{
    --bg:#0e0f14;
    --ink:#e6e6e6;
    --ink-dim:#b8b8c2;
    --acc1:#7AE582;
    --acc2:#5AA9E6;
    --acc3:#FFD166;
    --acc4:#EF476F;
    --ring:#8a8aff; /* Güvenli alan (korundu) */
    --shadow: rgba(0,0,0,0.5);
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  #c{display:block;width:100vw;height:100vh;touch-action:none;background:#111}

  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .panel{pointer-events:auto;background:rgba(20,22,30,0.85);backdrop-filter: blur(6px);
    border:1px solid rgba(255,255,255,0.08); border-radius:14px; padding:20px 22px; max-width:min(720px,92vw);
    box-shadow:0 10px 30px var(--shadow)}
  h1{margin:0 0 8px;font-size:24px}
  p{margin:6px 0 10px;line-height:1.5;color:var(--ink-dim)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{appearance:none;border:0;border-radius:10px;padding:12px 16px;font-weight:600;cursor:pointer;
    background:linear-gradient(180deg,#2a2f3c,#1b1f2b); color:var(--ink); box-shadow:0 6px 16px var(--shadow)}
  .btn:active{transform:translateY(1px)}
  .k{display:inline-block;padding:2px 8px;border-radius:6px;background:#202432;color:var(--ink);border:1px solid rgba(255,255,255,0.08);font-weight:600}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:640px){.grid{grid-template-columns:1fr}}

  #mob{position:fixed;left:10px;right:110px;bottom:10px;display:flex;gap:10px;pointer-events:none}
  .mbtn{pointer-events:auto;min-width:110px;padding:10px 12px;border-radius:12px;background:#1e2330;color:var(--ink);border:1px solid rgba(255,255,255,0.08)}

  /* Dairesel bariyer butonu — %33 küçültüldü */
  #barUI{position:fixed;right:12px;bottom:12px;width:59px;height:59px;pointer-events:none}
  #barBtn{
    position:absolute;inset:0;margin:0;border:0;border-radius:50%;
    background:#1c2130;color:var(--ink);font-weight:700;font-size:12px;
    box-shadow:0 10px 26px var(--shadow), inset 0 0 0 2px rgba(255,255,255,0.08);
    cursor:pointer;pointer-events:auto
  }
  #barRing{position:absolute;inset:-4px;width:calc(100% + 8px);height:calc(100% + 8px);pointer-events:none}
</style>
</head>
<body>
<canvas id="c"></canvas>

<!-- Menü (korundu) -->
<div class="overlay" id="menu">
  <div class="panel">
    <h1>HALKA</h1>
    <p>Merkeze yakın kal, güvenli halka daralırken hayatta kal. Düşmanları yok et, shard topla, bariyerleri akıllıca kullan.</p>
    <div class="grid">
      <div>
        <strong>Kontroller (PC)</strong>
        <p><span class="k">WASD</span> hareket • Fare: nişan • <span class="k">Sol Tık</span> ateş<br>
           <span class="k">Shift</span> dash • <span class="k">E</span> yer bariyeri • <span class="k">R</span> yön • <span class="k">Esc</span> duraklat</p>
      </div>
      <div>
        <strong>Mobil</strong>
        <p>Sol alan: hareket • Sağ alan: nişan/ateş • Sağ alttaki dairesel buton: yer bariyeri.</p>
      </div>
    </div>
    <div style="margin:8px 0 12px"><span>En İyi Skor: </span><span id="best">0</span></div>
    <div class="row"><button class="btn" id="start">BAŞLA</button><button class="btn" id="how">NASIL OYNANIR</button></div>
    <div id="howbox" style="display:none;margin-top:10px"><p style="color:var(--ink-dim);font-size:13px">5 shard = 1 yer bariyeri. Ayrıca <strong>her 10 öldürmede</strong> otomatik koruyucu bariyer <strong>5 sn</strong> aktif olur.</p></div>
  </div>
</div>

<div id="mob" aria-hidden="true"><button class="mbtn" id="mbPause">Duraklat (Esc)</button></div>

<!-- Dairesel bariyer butonu ve halka -->
<div id="barUI" aria-hidden="false">
  <button id="barBtn" title="Yer Bariyeri (E)">B</button>
  <canvas id="barRing"></canvas>
</div>

<script>
(()=>{ 'use strict';

/* ====== Yardımcılar ====== */
const rand=(a=1,b=0)=>Math.random()*(b-a)+a;
const clamp=(v,min,max)=>v<min?min:(v>max?max:v);
const lerp=(a,b,t)=>a+(b-a)*t;
const dist=(x1,y1,x2,y2)=>Math.hypot(x2-x1,y2-y1);
const now=()=>performance.now();

/* ====== Canvas / DPR ====== */
const dpr=Math.max(1,Math.min(2,devicePixelRatio||1));
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d',{alpha:false,desynchronized:true});
function resize(){canvas.width=Math.floor(innerWidth*dpr);canvas.height=Math.floor(innerHeight*dpr);canvas.style.width=innerWidth+'px';canvas.style.height=innerHeight+'px';}
addEventListener('resize',resize,{passive:true}); resize();

/* ====== Ses ====== */
const AC=window.AudioContext||window.webkitAudioContext; const audio=new AC(); let muted=false;
function beep({freq=440,time=0.06,type='sine',vol=0.05}={}){ if(muted) return; const t0=audio.currentTime; const o=audio.createOscillator(); const g=audio.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=vol; g.gain.setValueAtTime(vol,t0); g.gain.exponentialRampToValueAtTime(0.0001,t0+time); o.connect(g).connect(audio.destination); o.start(t0); o.stop(t0+time); }
const sShoot=()=>beep({freq:720,time:.05,type:'square',vol:0.06});
const sHit=()=>beep({freq:160,time:.08,type:'sawtooth',vol:0.06});
const sKill=()=>beep({freq:320,time:.09,type:'triangle',vol:0.07});
const sShard=()=>beep({freq:520,time:.06,type:'sine',vol:0.05});
const sHurt=()=>beep({freq:110,time:.12,type:'sawtooth',vol:0.08});
const sDash=()=>beep({freq:900,time:.05,type:'square',vol:0.06});
const sBarrier=()=>beep({freq:460,time:.12,type:'triangle',vol:0.07});

/* ====== Durum / UI ====== */
const State={MENU:0,PLAY:1,PAUSE:2,DEAD:3}; let state=State.MENU;
const menuEl=document.getElementById('menu'); const startBtn=document.getElementById('start'); const howBtn=document.getElementById('how'); const howBox=document.getElementById('howbox'); const bestEl=document.getElementById('best');
const mbPauseBtn=document.getElementById('mbPause');
const barBtn=document.getElementById('barBtn'); const ring=document.getElementById('barRing'); const rctx=ring.getContext('2d');
function sizeRing(){ const px=59; ring.width=Math.floor((px+8)*dpr); ring.height=Math.floor((px+8)*dpr); ring.style.width=(px+8)+'px'; ring.style.height=(px+8)+'px'; }
sizeRing(); addEventListener('resize',sizeRing,{passive:true});
const LS_KEY='HALKA_BEST'; let bestScore=+(localStorage.getItem(LS_KEY)||0); bestEl.textContent=bestScore.toLocaleString('tr-TR');

const world={w:()=>canvas.width,h:()=>canvas.height,cx:()=>canvas.width/2,cy:()=>canvas.height/2};

/* ====== Oyuncu / Parametreler ====== */
const player={x:world.cx(),y:world.cy(),vx:0,vy:0,r:14*dpr,hp:100,hpMax:100,fireCD:0,fireRate:.12, dashCD:0,dashCDMax:1.2,dashPow:7*dpr, shards:0,score:0,mult:1,multTimer:0};
const params={safeRadius:Math.min(world.w(),world.h())*0.42,safeShrinkPerSec:8*dpr,outDPS:14,enemySpawn:0,enemySpawnRate:0.9,enemySpeedBase:0.18*dpr,enemyHpBase:16,enemyRamp:0};

/* ====== Otomatik Koruyucu Bariyer (her 10 kill, 5 sn) ====== */
let killsSinceLastActivation=0;
let barrierAutoActive=false;
const barrierAutoDuration=5.0; // saniye
let barrierAutoTimer=0;
const barrierRadius=58*dpr; // çember yarıçapı

/* ====== Yer Bariyeri (orijinal mekanik, korundu) ====== */
let barrierRot=0; const barriers=[]; let barrierIdSeq=1;
const barrierHPDrain=2;
const barrierCD={cd:0,cdMax:5.0};
function placeBarrier(){
  if(player.shards<5 || barrierCD.cd>0) return;
  player.shards-=5; sBarrier();
  const rot=barrierRot?Math.PI/2:0; const len=80*dpr, thick=12*dpr;
  const dx=Math.cos(rot), dy=Math.sin(rot);
  barriers.push({id:barrierIdSeq++, x:clamp(player.x+dx*24*dpr,40,world.w()-40), y:clamp(player.y+dy*24*dpr,40,world.h()-40), w:rot?thick:len, h:rot?len:thick, hp:140,hpMax:140, rot});
  barrierCD.cd=barrierCD.cdMax;
}

/* ====== Girdi ====== */
const keys=new Set();
addEventListener('keydown',e=>{
  if(e.key===' '||e.key==='ArrowUp') e.preventDefault();
  keys.add(e.key.toLowerCase());
  if(e.key==='Escape'){ state=state===State.PLAY?State.PAUSE:State.PLAY; menuEl.style.display= state===State.PLAY?'none':''; }
});
addEventListener('keyup',e=>keys.delete(e.key.toLowerCase()));
let mouse={x:world.cx(),y:world.cy(),down:false};
canvas.addEventListener('mousemove',e=>{mouse.x=e.offsetX*dpr;mouse.y=e.offsetY*dpr;});
canvas.addEventListener('mousedown',e=>{mouse.down=true; audio.resume();});
canvas.addEventListener('mouseup',()=>{mouse.down=false;});
canvas.addEventListener('contextmenu',e=>e.preventDefault());
mbPauseBtn.addEventListener('click',()=>{state=state===State.PLAY?State.PAUSE:State.PLAY; menuEl.style.display= state===State.PLAY?'none':'';});
barBtn.addEventListener('click',()=>placeBarrier());

/* ====== Menü butonları ====== */
startBtn.onclick=()=>resetGame();
howBtn.onclick=()=>{howBox.style.display= howBox.style.display?'':'none'};

/* ====== Nesneler ====== */
const bullets=[], enemies=[], shards=[], particles=[];

/* ====== Spawn ====== */
function spawnEnemy(){
  const pad=40*dpr; const side=(Math.random()*4)|0; let x,y;
  if(side===0){x=rand(-pad,world.w()+pad);y=-pad;}
  else if(side===1){x=world.w()+pad;y=rand(-pad,world.h()+pad);}
  else if(side===2){x=rand(-pad,world.w()+pad);y=world.h()+pad;}
  else {x=-pad;y=rand(-pad,world.h()+pad);}
  const speed=params.enemySpeedBase + params.enemyRamp*0.02 + rand(0.02,0.08)*dpr;
  const hp=params.enemyHpBase + params.enemyRamp*2 + (Math.random()*6|0);
  enemies.push({x,y,vx:0,vy:0,r:12*dpr,speed,hp,maxhp:hp});
}

/* ====== Reset ====== */
function resetGame(){
  state=State.PLAY; menuEl.style.display='none';
  Object.assign(player,{x:world.cx(),y:world.cy(),vx:0,vy:0,hp:100,shards:0,score:0,mult:1,multTimer:0,fireCD:0,dashCD:0});
  bullets.length=enemies.length=shards.length=barriers.length=particles.length=0;
  params.safeRadius=Math.min(world.w(),world.h())*0.42; params.enemySpawn=0; params.enemyRamp=0;
  killsSinceLastActivation=0; barrierAutoActive=false; barrierAutoTimer=0; barrierCD.cd=0;
}

/* ====== Ateş ====== */
function shoot(){
  const ang=Math.atan2(mouse.y-player.y, mouse.x-player.x); const spd=8*dpr;
  bullets.push({x:player.x,y:player.y,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,r:4*dpr,life:1.1});
  sShoot();
}

/* ====== Oyun Döngüsü Değişkeni (tek tanım!) ====== */
let tPrev=now();

/* ====== Güncelle ====== */
function step(dt){
  // Zorluk/Spawn
  params.safeRadius=Math.max(50*dpr, params.safeRadius - params.safeShrinkPerSec*dt);
  params.enemyRamp+=dt; params.enemySpawn+=dt*params.enemySpawnRate*(1+params.enemyRamp*0.01);
  while(params.enemySpawn>1){params.enemySpawn-=1;spawnEnemy();}

  // Girdi-hareket
  let mx=0,my=0; if(keys.has('w')||keys.has('arrowup')) my-=1; if(keys.has('s')||keys.has('arrowdown')) my+=1; if(keys.has('a')||keys.has('arrowleft')) mx-=1; if(keys.has('d')||keys.has('arrowright')) mx+=1;
  player.dashCD=Math.max(0,player.dashCD-dt);
  if((keys.has('shift')||keys.has('ş')) && player.dashCD<=0){ const v=Math.hypot(mx,my); if(v>0.1){ player.vx+=(mx/v)*player.dashPow; player.vy+=(my/v)*player.dashPow; player.dashCD=player.dashCDMax; sDash(); } }
  player.fireCD=Math.max(0,player.fireCD-dt); if(mouse.down && player.fireCD<=0){ shoot(); player.fireCD=player.fireRate; }
  if(keys.has('e')){ keys.delete('e'); placeBarrier(); }
  if(keys.has('r')){ keys.delete('r'); barrierRot=1-barrierRot; }

  // Fizi̇k
  const mv=Math.hypot(mx,my); if(mv>0){mx/=mv;my/=mv;}
  player.vx=lerp(player.vx,mx*4*dpr,0.18); player.vy=lerp(player.vy,my*4*dpr,0.18);
  player.x=clamp(player.x+player.vx,10,world.w()-10); player.y=clamp(player.y+player.vy,10,world.h()-10);

  // Güvenli alan hasarı
  if(dist(player.x,player.y,world.cx(),world.cy())>params.safeRadius){ player.hp -= params.outDPS*dt; }

  // Mermiler
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i]; b.x+=b.vx; b.y+=b.vy; b.life-=dt;
    if(b.life<=0 || b.x<-20||b.x>world.w()+20||b.y<-20||b.y>world.h()+20){ bullets.splice(i,1); continue; }
    for(const bar of barriers){
      if(b.x>bar.x-bar.w/2 && b.x<bar.x+bar.w/2 && b.y>bar.y-bar.h/2 && b.y<bar.y+bar.h/2){
        bullets.splice(i,1); bar.hp-=12; break;
      }
    }
  }

  // Düşmanlar
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    const ang=Math.atan2(player.y-e.y, player.x-e.x);
    e.vx=Math.cos(ang)*e.speed; e.vy=Math.sin(ang)*e.speed;
    e.x+=e.vx; e.y+=e.vy;

    // Yer bariyeri iter/hasar verir
    for(const bar of barriers){
      if(e.x>bar.x-bar.w/2 && e.x<bar.x+bar.w/2 && e.y>bar.y-bar.h/2 && e.y<bar.y+bar.h/2){
        e.x -= e.vx*5; e.y -= e.vy*5; bar.hp -= 20*dt;
      }
    }

    // KORUYUCU BARİYER: değerse anında ölür
    if(barrierAutoActive && dist(e.x,e.y,player.x,player.y) <= barrierRadius + e.r){
      enemies.splice(i,1); onEnemyKilled(e); continue;
    }

    // Güvenli alan hasarı (düşmana)
    if(dist(e.x,e.y,world.cx(),world.cy())>params.safeRadius) e.hp -= 8*dt;

    // Mermi çarpışması
    for(let j=bullets.length-1;j>=0;j--){
      const b=bullets[j];
      if(dist(b.x,b.y,e.x,e.y) < e.r + b.r){
        bullets.splice(j,1); e.hp -= 20; sHit();
        particles.push({x:e.x,y:e.y,life:.2,color:getCSS('--acc4')});
      }
    }

    // Oyuncuya çarpma
    if(dist(e.x,e.y,player.x,player.y) < e.r + player.r){ player.hp -= 22*dt; sHurt(); player.vx -= e.vx*0.6; player.vy -= e.vy*0.6; }

    // Öldü mü?
    if(e.hp<=0){ enemies.splice(i,1); onEnemyKilled(e); }
  }

  // Shard toplama
  for(let i=shards.length-1;i>=0;i--){
    const s=shards[i]; s.life-=dt;
    if(dist(s.x,s.y,player.x,player.y)<player.r+8*dpr){
      shards.splice(i,1); player.shards++; sShard();
      particles.push({x:player.x,y:player.y,life:.3,color:getCSS('--acc1')});
    } else if(s.life<=0){shards.splice(i,1);}
  }

  // Yer bariyeri ömrü
  for(let i=barriers.length-1;i>=0;i--){
    const b=barriers[i]; b.hp-= barrierHPDrain*dt; if(b.hp<=0) barriers.splice(i,1);
  }

  // Otomatik bariyer zamanlayıcı
  if(barrierAutoActive){
    barrierAutoTimer -= dt;
    if(barrierAutoTimer<=0){ barrierAutoActive=false; barrierAutoTimer=0; }
  }

  // Yer bariyeri CD
  if(barrierCD.cd>0){ barrierCD.cd=Math.max(0, barrierCD.cd - dt); }

  // Çarpan süresi
  if(player.mult>1){ player.multTimer-=dt; if(player.multTimer<=0){ player.mult=Math.max(1,Math.floor(player.mult)); } }

  // Oyun sonu
  if(player.hp<=0) endGame();
}

/* ====== Öldürme sonrası ====== */
function onEnemyKilled(e){
  sKill();
  player.score += 10*player.mult;
  player.mult = Math.min(8, player.mult+0.1); player.multTimer = 3;
  if(Math.random()<0.9){ shards.push({x:e.x,y:e.y,r:6*dpr,life:8}); }
  for(let k=0;k<6;k++) particles.push({x:e.x+rand(-6,6),y:e.y+rand(-6,6),life:.4,color:getCSS('--acc4')});
  killsSinceLastActivation++;
  if(!barrierAutoActive && killsSinceLastActivation>=10){ activateAutoBarrier(); }
}

function activateAutoBarrier(){
  barrierAutoActive=true; barrierAutoTimer=barrierAutoDuration; killsSinceLastActivation=0; sBarrier();
}

/* ====== Çizim ====== */
function getCSS(n){return getComputedStyle(document.documentElement).getPropertyValue(n).trim();}

function draw(){
  ctx.fillStyle=getCSS('--bg'); ctx.fillRect(0,0,world.w(),world.h());

  // Güvenli alan — mavi kesikli çember (korundu)
  ctx.save(); ctx.translate(world.cx(),world.cy());
  ctx.beginPath(); ctx.arc(0,0,params.safeRadius,0,Math.PI*2);
  ctx.strokeStyle=getCSS('--ring'); ctx.lineWidth=4*dpr; ctx.setLineDash([6*dpr,6*dpr]); ctx.stroke();
  ctx.restore();

  // Shards
  for(const s of shards){ ctx.fillStyle=getCSS('--acc1'); ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill(); }

  // Yer bariyerleri (oynanış için hafif görünür)
  for(const b of barriers){
    ctx.save(); ctx.translate(b.x,b.y);
    ctx.globalAlpha=0.08; ctx.fillStyle='#fff'; ctx.strokeStyle='#fff'; ctx.lineWidth=2*dpr;
    ctx.beginPath(); ctx.rect(-b.w/2,-b.h/2,b.w,b.h); ctx.fill(); ctx.stroke();
    ctx.globalAlpha=1; ctx.restore();
  }

  // Mermiler
  ctx.fillStyle=getCSS('--acc2'); for(const b of bullets){ ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); }

  // Düşmanlar
  for(const e of enemies){
    const hpR=Math.max(0, Math.min(1, e.hp/e.maxhp));
    ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2);
    ctx.fillStyle=getCSS('--acc4'); ctx.globalAlpha=0.8; ctx.fill(); ctx.globalAlpha=1;
    ctx.beginPath(); ctx.arc(e.x,e.y,e.r+3*dpr,-Math.PI/2,-Math.PI/2+hpR*2*Math.PI);
    ctx.strokeStyle=getCSS('--acc3'); ctx.lineWidth=2*dpr; ctx.stroke();
  }

  // Oyuncu
  ctx.save(); ctx.translate(player.x,player.y);
  ctx.fillStyle='rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.arc(3*dpr,3*dpr,player.r,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(0,0,player.r,0,Math.PI*2); ctx.fillStyle='#dfe7fd'; ctx.fill();
  ctx.restore();

  // Koruyucu bariyer görseli
  if(barrierAutoActive){
    // Beyaz parlak tam çember
    ctx.save();
    ctx.shadowColor='#fff'; ctx.shadowBlur=20*dpr;
    ctx.strokeStyle='#ffffff'; ctx.lineWidth=4*dpr;
    ctx.beginPath(); ctx.arc(player.x, player.y, barrierRadius, 0, Math.PI*2); ctx.stroke();
    ctx.shadowBlur=0; ctx.restore();
  }else{
    // Pasif: gri kesik çember
    ctx.save(); ctx.setLineDash([8*dpr,8*dpr]); ctx.strokeStyle='#9aa0a6'; ctx.lineWidth=2*dpr;
    ctx.beginPath(); ctx.arc(player.x, player.y, barrierRadius, 0, Math.PI*2); ctx.stroke();
    ctx.setLineDash([]); ctx.restore();
  }

  // Parçacıklar
  for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.life-=1/60;
    ctx.globalAlpha=Math.max(0,p.life*2); ctx.fillStyle=p.color; ctx.fillRect(p.x-2*dpr,p.y-2*dpr,4*dpr,4*dpr);
    if(p.life<=0) particles.splice(i,1); ctx.globalAlpha=1;
  }

  // HUD
  const pad=10*dpr; ctx.font=`${14*dpr}px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif`; ctx.fillStyle=getCSS('--ink');
  ctx.fillText(`Skor: ${Math.floor(player.score).toLocaleString('tr-TR')}`, pad, 20*dpr);
  ctx.fillText(`Çarpan: x${player.mult.toFixed(1)}`, pad, 38*dpr);
  ctx.fillText(`Shard: ${player.shards}`, pad, 56*dpr);

  // HP bar
  const barW=160*dpr, barH=10*dpr; const hpR=Math.max(0,Math.min(1,player.hp/player.hpMax));
  ctx.fillStyle='#1d2230'; ctx.fillRect(pad, 66*dpr, barW, barH);
  ctx.fillStyle=getCSS('--acc1'); ctx.fillRect(pad, 66*dpr, barW*hpR, barH);

  // Güvenli Alan bilgisi
  ctx.fillStyle=getCSS('--ink-dim'); ctx.fillText(`Güvenli Alan: ${(params.safeRadius/dpr|0)} px`, pad, 92*dpr);

  drawBarrierRingUI(); // UI halka en sonda
}

/* ====== Dairesel buton halkası (UI) ====== */
function drawBarrierRingUI(){
  const w=ring.width,h=ring.height; rctx.clearRect(0,0,w,h);
  const cx=w/2, cy=h/2; const rad=Math.min(w,h)/2 - 6*dpr;
  if(barrierAutoActive){
    const ratio=Math.max(0,Math.min(1, barrierAutoTimer/barrierAutoDuration));
    rctx.lineWidth=8*dpr; rctx.strokeStyle='#2ee66a'; // yeşil
    rctx.beginPath(); rctx.arc(cx,cy,rad,-Math.PI/2,-Math.PI/2 + ratio*2*Math.PI); rctx.stroke();
  }else{
    const t=performance.now()/700; const alpha=0.8 + 0.2*Math.sin(t);
    rctx.lineWidth=8*dpr; rctx.strokeStyle=`rgba(239,71,111,${alpha.toFixed(3)})`; // kırmızı
    rctx.beginPath(); rctx.arc(cx,cy,rad,0,Math.PI*2); rctx.stroke();
  }
}

/* ====== Game Over ====== */
function endGame(){
  state=State.DEAD; menuEl.style.display='';
  startBtn.textContent='YENİDEN BAŞLA';
  const s=Math.floor(player.score); if(s>+bestScore){bestScore=s; localStorage.setItem(LS_KEY,bestScore); bestEl.textContent=bestScore.toLocaleString('tr-TR');}
}

/* ====== Döngü ====== */
function loop(){ const t=now(); let dt=(t-tPrev)/1000; tPrev=t; dt=Math.min(dt,0.033);
  if(state===State.PLAY) step(dt); draw(); requestAnimationFrame(loop); }
requestAnimationFrame(loop);

/* ====== Diğer ====== */
addEventListener('visibilitychange',()=>{ if(document.hidden && state===State.PLAY){state=State.PAUSE; menuEl.style.display='';}});
addEventListener('blur',()=>{ if(state===State.PLAY){state=State.PAUSE; menuEl.style.display='';}});
canvas.addEventListener('click',()=>audio.resume(),{once:true});
document.addEventListener('keydown',e=>{ if(e.key.toLowerCase()==='m'){muted=!muted;} });

})(); 
</script>
</body>
</html>
