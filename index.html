<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>HALKA — Tek Dosya Tarayıcı Oyunu</title>
<style>
  :root{
    --bg:#0e0f14;
    --ink:#e6e6e6;
    --ink-dim:#b8b8c2;
    --acc1:#7AE582; /* sağlık/yaratım */
    --acc2:#5AA9E6; /* cephane/enerji */
    --acc3:#FFD166; /* uyarı */
    --acc4:#EF476F; /* hasar/düşman */
    --ring:#8a8aff; /* güvenli alan */
    --shadow: rgba(0,0,0,0.5);
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  #c{display:block;width:100vw;height:100vh;touch-action:none;}
  .overlay{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    pointer-events:none;
  }
  .panel{
    pointer-events:auto;background:rgba(20,22,30,0.85);backdrop-filter: blur(6px);
    border:1px solid rgba(255,255,255,0.08); border-radius:14px; padding:20px 22px; max-width: min(720px,92vw);
    box-shadow:0 10px 30px var(--shadow);
  }
  h1{margin:0 0 8px;font-size:24px;letter-spacing:.5px}
  p{margin:6px 0 10px;line-height:1.5;color:var(--ink-dim)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{
    appearance:none;border:0;border-radius:10px;padding:12px 16px;font-weight:600;cursor:pointer;
    background:linear-gradient(180deg,#2a2f3c,#1b1f2b); color:var(--ink);
    box-shadow:0 6px 16px var(--shadow);
  }
  .btn:active{transform:translateY(1px)}
  .k{display:inline-block;padding:2px 8px;border-radius:6px;background:#202432;color:var(--ink);border:1px solid rgba(255,255,255,0.08);font-weight:600}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:640px){.grid{grid-template-columns:1fr}}
  /* Mobil butonları */
  #mob{
    position:fixed;left:10px;right:10px;bottom:10px;display:flex;justify-content:space-between;gap:10px;pointer-events:none;
  }
  .mbtn{pointer-events:auto;min-width:110px;padding:10px 12px;border-radius:12px;background:#1e2330;color:var(--ink);border:1px solid rgba(255,255,255,0.08)}
  .hint{font-size:12px;color:var(--ink-dim)}

  /* Bariyer HUD kutuları */
  .hud{
    position:fixed;right:10px;top:10px;display:flex;flex-direction:column;gap:8px;
    background:rgba(20,22,30,0.6);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:10px 12px;
    box-shadow:0 8px 24px var(--shadow); pointer-events:none; min-width:220px;
  }
  .bar{height:10px;background:#1d2230;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.06)}
  .bar>i{display:block;height:100%;width:0%}
  .barrier-health>i{background:linear-gradient(90deg,var(--acc1),#b5f7bd)}
  .barrier-cd>i{background:linear-gradient(90deg,var(--acc2),#b8dcff)}
  .hud .row2{display:flex;justify-content:space-between;font-size:12px;color:var(--ink-dim)}
</style>
</head>
<body>
<canvas id="c"></canvas>

<!-- Başlangıç / Duraklat menüsü -->
<div class="overlay" id="menu">
  <div class="panel">
    <h1>HALKA</h1>
    <p>Merkeze yakın kal, güvenli halka daralırken hayatta kal. Düşmanları yok et, <span style="color:var(--acc1);font-weight:600">shard</span> topla, bariyer kur.</p>
    <div class="grid">
      <div>
        <strong>Kontroller (PC)</strong>
        <p><span class="k">WASD</span> hareket • Fare: nişan • <span class="k">Sol Tık</span> ateş<br>
           <span class="k">Shift</span> dash • <span class="k">E</span> bariyer (5 shard) • <span class="k">R</span> döndür • <span class="k">Esc</span> duraklat</p>
      </div>
      <div>
        <strong>Mobil</strong>
        <p>Sol alan: hareket • Sağ alan: nişan+ateş • Alttaki “Bariyer” ile kur.</p>
      </div>
    </div>
    <div style="margin:8px 0 12px">
      <span>En İyi Skor: </span><span id="best">0</span>
    </div>
    <div class="row">
      <button class="btn" id="start">BAŞLA</button>
      <button class="btn" id="how">NASIL OYNANIR</button>
    </div>
    <div id="howbox" style="display:none;margin-top:10px">
      <p class="hint">Shard: 5 adet = 1 bariyer. Bariyer mermiyi durdurur, düşmanı engeller, dayanıklılığı tükenince yok olur. Güvenli halka sürekli daralır; halkaya dışarıda kalmak can kaybettirir.</p>
    </div>
  </div>
</div>

<!-- Bariyer HUD (koruma ve bekleme süresi) -->
<div class="hud" id="hudBox" aria-hidden="true">
  <div style="font-weight:600">Bariyer Durumu</div>
  <div class="row2"><span>Koruma (HP)</span><span id="bhpTxt">—</span></div>
  <div class="bar barrier-health"><i id="bhpBar"></i></div>
  <div class="row2"><span>Yeniden Kullanım</span><span id="bcdTxt">Hazır</span></div>
  <div class="bar barrier-cd"><i id="bcdBar"></i></div>
  <div class="row2"><span>Shard</span><span id="shardTxt">0</span></div>
</div>

<!-- Mobil butonları -->
<div id="mob" aria-hidden="true">
  <button class="mbtn" id="mbBarrier">Bariyer (E)</button>
  <button class="mbtn" id="mbPause">Duraklat (Esc)</button>
</div>

<script>
(()=>{
'use strict';

/* =========  Yardımcılar  ========= */
const rand = (a=1,b=0)=>Math.random()*(b-a)+a;
const clamp=(v,min,max)=>v<min?min:(v>max?max:v);
const lerp=(a,b,t)=>a+(b-a)*t;
const dist=(x1,y1,x2,y2)=>Math.hypot(x2-x1,y2-y1);
const now = ()=>performance.now();

/* =========  Canvas & Boyut  ========= */
const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d',{alpha:false,desynchronized:true});
function resize(){
  canvas.width = Math.floor(innerWidth * dpr);
  canvas.height= Math.floor(innerHeight* dpr);
  canvas.style.width = innerWidth+'px';
  canvas.style.height= innerHeight+'px';
}
addEventListener('resize', resize,{passive:true}); resize();

/* =========  Ses (WebAudio)  ========= */
const AC = window.AudioContext || window.webkitAudioContext;
const audio = new AC();
let muted = false;
function beep({freq=440, time=0.06, type='sine', vol=0.05}={}){
  if(muted) return;
  const t0 = audio.currentTime;
  const o = audio.createOscillator();
  const g = audio.createGain();
  o.type=type; o.frequency.value = freq;
  g.gain.value = vol; g.gain.setValueAtTime(vol,t0);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + time);
  o.connect(g).connect(audio.destination);
  o.start(t0); o.stop(t0 + time);
}
function sShoot(){beep({freq:720,time:.05,type:'square',vol:0.06});}
function sHit(){beep({freq:160,time:.08,type:'sawtooth',vol:0.06});}
function sKill(){beep({freq:320,time:.09,type:'triangle',vol:0.07});}
function sShard(){beep({freq:520,time:.06,type:'sine',vol:0.05});}
function sHurt(){beep({freq:110,time:.12,type:'sawtooth',vol:0.08});}
function sDash(){beep({freq:900,time:.05,type:'square',vol:0.06});}
function sBarrier(){beep({freq:440,time:.12,type:'triangle',vol:0.06});}

/* =========  Oyun Durumu  ========= */
const State = { MENU:0, PLAY:1, PAUSE:2, DEAD:3 };
let state = State.MENU;

const menuEl = document.getElementById('menu');
const bestEl = document.getElementById('best');
const startBtn = document.getElementById('start');
const howBtn = document.getElementById('how');
const howBox = document.getElementById('howbox');

const hudBox = document.getElementById('hudBox');
const bhpBar = document.getElementById('bhpBar');
const bcdBar = document.getElementById('bcdBar');
const bhpTxt = document.getElementById('bhpTxt');
const bcdTxt = document.getElementById('bcdTxt');
const shardTxt = document.getElementById('shardTxt');

const mbBarrierBtn = document.getElementById('mbBarrier');
const mbPauseBtn = document.getElementById('mbPause');

const LS_KEY='HALKA_BEST';
let bestScore = +(localStorage.getItem(LS_KEY)||0);
bestEl.textContent = bestScore.toLocaleString('tr-TR');

let tPrev=now();

/* =========  Dünya  ========= */
const world = {
  w: ()=>canvas.width, h: ()=>canvas.height,
  cx: ()=>canvas.width/2, cy: ()=>canvas.height/2
};

/* =========  Oyuncu & Sistemler  ========= */
const player = {
  x:0,y:0, vx:0,vy:0, r:14*dpr, speed: 0.75*dpr,
  hp:100, hpMax:100,
  dashCD:0, dashCDMax: 1.2, dashPow: 7*dpr,
  fireCD:0, fireRate: 0.12,
  shards:0, score:0, mult:1, multTimer:0,
};

const params = {
  safeRadius: 0,
  safeShrinkPerSec: 8*dpr,
  outDPS: 14,
  enemySpawn: 0, enemySpawnRate: 0.9,
  enemySpeedBase: 0.18*dpr,
  enemyHpBase: 16,
  enemyRamp: 0,
};

/* =========  Bariyer Sistemi (Yeni: CD & HP HUD)  ========= */
let barrierRot = 0;
let barrierIdSeq = 1;
let lastBarrierId = null; // son yerleştirilen bariyeri HUD'da izlemek için
const barrier = { cd:0, cdMax:5.0 }; // 5 sn bekleme
const bullets=[], enemies=[], shards=[], barriers=[], particles=[];

function resetGame(){
  state = State.PLAY;
  menuEl.style.display='none';
  hudBox.style.display='';
  const cx=world.cx(), cy=world.cy();
  Object.assign(player,{x:cx,y:cy,vx:0,vy:0,hp:100,shards:0,score:0,mult:1,multTimer:0,fireCD:0,dashCD:0});
  bullets.length=enemies.length=shards.length=barriers.length=particles.length=0;
  params.safeRadius = Math.min(world.w(),world.h())*0.42;
  params.enemySpawn=0; params.enemyRamp=0; params.enemySpawnRate=0.9;
  barrier.cd=0; lastBarrierId=null;
  updateBarrierHUD();
}
function gameOver(){
  state=State.DEAD;
  menuEl.style.display='';
  hudBox.style.display='';
  startBtn.textContent='YENİDEN BAŞLA';
  const s = Math.floor(player.score);
  if(s>bestScore){bestScore=s; localStorage.setItem(LS_KEY,bestScore); bestEl.textContent=bestScore.toLocaleString('tr-TR');}
}

/* =========  Girdi (PC)  ========= */
const keys = new Set();
addEventListener('keydown',e=>{
  if(e.key===' '||e.key==='ArrowUp') e.preventDefault();
  keys.add(e.key.toLowerCase());
  if(e.key==='Escape'){
    if(state===State.PLAY){state=State.PAUSE; menuEl.style.display='';}
    else if(state===State.PAUSE){state=State.PLAY; menuEl.style.display='none';}
  }
});
addEventListener('keyup',e=>{keys.delete(e.key.toLowerCase());});
let mouse={x:0,y:0,down:false};
canvas.addEventListener('mousemove',e=>{mouse.x=e.offsetX*dpr; mouse.y=e.offsetY*dpr;});
canvas.addEventListener('mousedown',e=>{
  mouse.down=true; audio.resume();
  if(e.button===2) e.preventDefault();
});
canvas.addEventListener('mouseup',()=>{mouse.down=false;});
canvas.addEventListener('contextmenu',e=>e.preventDefault());

/* =========  Girdi (Mobil)  ========= */
let touchL=null,touchR=null;
canvas.addEventListener('touchstart',e=>{
  audio.resume();
  for(const t of e.changedTouches){
    const isLeft = t.clientX < innerWidth/2;
    const o = {id:t.identifier, sx:t.clientX, sy:t.clientY, x:t.clientX, y:t.clientY};
    if(isLeft && !touchL) touchL=o; else if(!isLeft && !touchR) touchR=o;
  }
},{passive:true});
canvas.addEventListener('touchmove',e=>{
  for(const t of e.changedTouches){
    if(touchL && t.identifier===touchL.id){touchL.x=t.clientX; touchL.y=t.clientY;}
    if(touchR && t.identifier===touchR.id){touchR.x=t.clientX; touchR.y=t.clientY;}
  }
},{passive:true});
canvas.addEventListener('touchend',e=>{
  for(const t of e.changedTouches){
    if(touchL && t.identifier===touchL.id) touchL=null;
    if(touchR && t.identifier===touchR.id) touchR=null;
  }
},{passive:true});
mbBarrierBtn.addEventListener('click',()=>placeBarrier());
mbPauseBtn.addEventListener('click',()=>{
  if(state===State.PLAY){state=State.PAUSE; menuEl.style.display='';}
  else if(state===State.PAUSE){state=State.PLAY; menuEl.style.display='none';}
});

/* =========  UI Butonları  ========= */
startBtn.onclick=()=>{resetGame();};
howBtn.onclick=()=>{howBox.style.display = howBox.style.display?'':'none';};

/* =========  Mekanikler  ========= */
function shoot(){
  const ang = Math.atan2(mouse.y-player.y, mouse.x-player.x);
  const spd = 8*dpr;
  bullets.push({x:player.x, y:player.y, vx:Math.cos(ang)*spd, vy:Math.sin(ang)*spd, r:4*dpr, life:1.1});
  sShoot();
}
function spawnEnemy(){
  const pad = 40*dpr;
  const side = Math.floor(rand(0,4));
  let x,y;
  if(side===0){x=rand(-pad, world.w()+pad); y=-pad;}
  else if(side===1){x=world.w()+pad; y=rand(-pad,world.h()+pad);}
  else if(side===2){x=rand(-pad, world.w()+pad); y=world.h()+pad;}
  else {x=-pad; y=rand(-pad,world.h()+pad);}
  const speed = params.enemySpeedBase + params.enemyRamp*0.02 + rand(0.02,0.08)*dpr;
  const hp = params.enemyHpBase + params.enemyRamp*2 + Math.floor(rand(0,6));
  enemies.push({x:x, y:y, vx:0, vy:0, r:12*dpr, speed, hp, maxhp:hp});
}
function placeBarrier(){
  // Şartlar: yeterli shard + CD bitmiş olmalı
  if(player.shards<5 || barrier.cd>0) return;
  player.shards-=5; sBarrier();
  const rot = barrierRot?Math.PI/2:0;
  const len = 80*dpr, thick=12*dpr;
  const dx = Math.cos(rot), dy=Math.sin(rot);
  const id = barrierIdSeq++;
  barriers.push({
    id,
    x: clamp(player.x + dx*24*dpr, 40, world.w()-40),
    y: clamp(player.y + dy*24*dpr, 40, world.h()-40),
    w: rot?thick:len, h: rot?len:thick,
    hp: 140, hpMax:140, rot
  });
  lastBarrierId = id;
  barrier.cd = barrier.cdMax; // CD başlat
  updateBarrierHUD();
}
function getLastBarrier(){
  if(lastBarrierId==null) return null;
  return barriers.find(b=>b.id===lastBarrierId) || null;
}

/* =========  Güncelle & Çiz  ========= */
function step(dt){
  if(state!==State.PLAY) return;

  // Zorluk ve halka
  params.safeRadius = Math.max(50*dpr, params.safeRadius - params.safeShrinkPerSec*dt);
  params.enemyRamp += dt;
  params.enemySpawn += dt * params.enemySpawnRate * (1 + params.enemyRamp*0.01);
  while(params.enemySpawn>1){ params.enemySpawn-=1; spawnEnemy(); }

  // Girdi — hareket
  let mx=0,my=0;
  if(keys.has('w')||keys.has('arrowup')) my-=1;
  if(keys.has('s')||keys.has('arrowdown')) my+=1;
  if(keys.has('a')||keys.has('arrowleft')) mx-=1;
  if(keys.has('d')||keys.has('arrowright')) mx+=1;

  // Mobil sol dokunma → hareket
  if(touchL){
    const dx = (touchL.x - touchL.sx), dy = (touchL.y - touchL.sy);
    const m = Math.hypot(dx,dy);
    if(m>10){ mx += dx/m; my += dy/m; }
  }

  // Dash
  player.dashCD = Math.max(0, player.dashCD - dt);
  if((keys.has('shift')||keys.has('ş')) && player.dashCD<=0){
    const v = Math.hypot(mx,my);
    if(v>0.1){ player.vx += (mx/v)*player.dashPow; player.vy += (my/v)*player.dashPow; player.dashCD=player.dashCDMax; sDash(); }
  }

  // Ateş
  player.fireCD = Math.max(0, player.fireCD - dt);
  const firing = mouse.down || !!touchR;
  if(firing && player.fireCD<=0){
    if(touchR){ mouse.x = touchR.x*dpr; mouse.y = touchR.y*dpr; }
    shoot(); player.fireCD = player.fireRate;
  }

  // Bariyer kur / döndür
  if(keys.has('e')){ keys.delete('e'); placeBarrier(); }
  if(keys.has('r')){ keys.delete('r'); barrierRot = 1 - barrierRot; }

  // Hareket fiziği
  const mv = Math.hypot(mx,my);
  if(mv>0){ mx/=mv; my/=mv; }
  player.vx = lerp(player.vx, mx*4*dpr, 0.18);
  player.vy = lerp(player.vy, my*4*dpr, 0.18);
  player.x = clamp(player.x + player.vx, 10, world.w()-10);
  player.y = clamp(player.y + player.vy, 10, world.h()-10);

  // Güvenli alan hasarı
  if(dist(player.x,player.y,world.cx(),world.cy())>params.safeRadius){
    player.hp -= params.outDPS*dt;
  }

  // Mermiler
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];
    b.x+=b.vx; b.y+=b.vy; b.life-=dt;
    if(b.life<=0 || b.x<-20||b.x>world.w()+20||b.y<-20||b.y>world.h()+20){ bullets.splice(i,1); continue; }
    // bariyer çarpışma
    for(const bar of barriers){
      if(b.x>bar.x-bar.w/2 && b.x<bar.x+bar.w/2 && b.y>bar.y-bar.h/2 && b.y<bar.y+bar.h/2){
        bullets.splice(i,1); bar.hp -= 12; break;
      }
    }
  }

  // Düşmanlar
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    const ang = Math.atan2(player.y-e.y, player.x-e.x);
    e.vx = Math.cos(ang)*e.speed; e.vy=Math.sin(ang)*e.speed;
    e.x += e.vx; e.y += e.vy;

    // Bariyerler düşmanı iter ve hasar aldırır
    for(const bar of barriers){
      if(e.x>bar.x-bar.w/2 && e.x<bar.x+bar.w/2 && e.y>bar.y-bar.h/2 && e.y<bar.y+bar.h/2){
        e.x -= e.vx*5; e.y -= e.vy*5; bar.hp -= 20*dt;
      }
    }

    // Güvenli alan dışında yavaş hasar
    if(dist(e.x,e.y,world.cx(),world.cy())>params.safeRadius) e.hp -= 8*dt;

    // Mermi çarpışma
    for(let j=bullets.length-1;j>=0;j--){
      const b=bullets[j];
      if(dist(b.x,b.y,e.x,e.y) < e.r + b.r){
        bullets.splice(j,1); e.hp -= 20; sHit();
        particles.push({x:e.x,y:e.y,life:.2,color:getCSS('--acc4')});
      }
    }

    // Oyuncuya çarpma
    if(dist(e.x,e.y,player.x,player.y) < e.r + player.r){
      player.hp -= 22*dt; sHurt();
      player.vx -= e.vx*0.6; player.vy -= e.vy*0.6;
    }

    // Öldü mü?
    if(e.hp<=0){
      enemies.splice(i,1); player.score += 10*player.mult; sKill();
      player.mult = Math.min(8, player.mult+0.1); player.multTimer = 3;
      if(Math.random()<0.9){ shards.push({x:e.x,y:e.y, r:6*dpr, life:8}); }
      for(let k=0;k<6;k++) particles.push({x:e.x+rand(-6,6),y:e.y+rand(-6,6),life:.4,color:getCSS('--acc4')});
    }
  }

  // Shard toplama
  for(let i=shards.length-1;i>=0;i--){
    const s=shards[i]; s.life-=dt;
    if(dist(s.x,s.y,player.x,player.y)<player.r+8*dpr){
      shards.splice(i,1); player.shards++; sShard();
      particles.push({x:player.x,y:player.y,life:.3,color:getCSS('--acc1')});
    } else if(s.life<=0){shards.splice(i,1);}
  }

  // Bariyer dayanıklılık ve ömür
  for(let i=barriers.length-1;i>=0;i--){
    const b=barriers[i]; b.hp-= 2*dt; // zamanla az miktar erisin
    if(b.hp<=0){barriers.splice(i,1);}
  }

  // Bariyer CD
  if(barrier.cd>0){ barrier.cd=Math.max(0, barrier.cd - dt); }

  // Çarpan zamanlayıcı
  if(player.mult>1){
    player.multTimer-=dt;
    if(player.multTimer<=0){ player.mult = Math.max(1, Math.floor(player.mult)); }
  }

  // Puan: zamana bağlı artış
  player.score += dt * (1 + params.enemyRamp*0.1) * player.mult;

  // HUD güncelle
  updateBarrierHUD();

  // Can bitti mi?
  if(player.hp<=0){ gameOver(); }
}

/* =========  Çizim  ========= */
function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

function draw(){
  ctx.fillStyle=getCSS('--bg'); ctx.fillRect(0,0,world.w(),world.h());

  // Güvenli halka
  ctx.save();
  ctx.translate(world.cx(),world.cy());
  ctx.beginPath(); ctx.arc(0,0,params.safeRadius,0,Math.PI*2);
  ctx.strokeStyle=getCSS('--ring'); ctx.lineWidth=4*dpr; ctx.setLineDash([6*dpr,6*dpr]);
  ctx.stroke();
  ctx.restore();

  // Shards
  for(const s of shards){
    ctx.fillStyle=getCSS('--acc1');
    ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
  }

  // Bariyerler
  for(const b of barriers){
    ctx.save(); ctx.translate(b.x,b.y);
    ctx.fillStyle='rgba(122,229,130,0.22)'; ctx.strokeStyle=getCSS('--acc1');
    ctx.lineWidth=2*dpr;
    ctx.beginPath(); ctx.rect(-b.w/2,-b.h/2,b.w,b.h); ctx.fill(); ctx.stroke();
    // HP üst göstergesi
    const r = clamp(b.hp/b.hpMax,0,1);
    ctx.fillStyle=getCSS('--acc1');
    ctx.fillRect(-b.w/2, -b.h/2-6*dpr, b.w*r, 4*dpr);
    ctx.restore();
  }

  // Mermiler
  ctx.fillStyle=getCSS('--acc2');
  for(const b of bullets){
    ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
  }

  // Düşmanlar
  for(const e of enemies){
    const hpR = clamp(e.hp/e.maxhp,0,1);
    ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2);
    ctx.fillStyle=getCSS('--acc4'); ctx.globalAlpha=0.8; ctx.fill(); ctx.globalAlpha=1;
    ctx.beginPath(); ctx.arc(e.x,e.y,e.r+3*dpr,-Math.PI/2,-Math.PI/2+hpR*2*Math.PI);
    ctx.strokeStyle=getCSS('--acc3'); ctx.lineWidth=2*dpr; ctx.stroke();
  }

  // Oyuncu
  ctx.save(); ctx.translate(player.x,player.y);
  ctx.fillStyle='rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.arc(3*dpr,3*dpr,player.r,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(0,0,player.r,0,Math.PI*2);
  ctx.fillStyle='#dfe7fd'; ctx.fill();
  ctx.strokeStyle=getCSS('--ink-dim'); ctx.lineWidth=2*dpr;
  ctx.beginPath(); ctx.moveTo(0,0); 
  const aimx=mouse.x||player.x, aimy=mouse.y||player.y;
  const ang=Math.atan2(aimy-player.y, aimx-player.x);
  ctx.lineTo(Math.cos(ang)*player.r*1.6, Math.sin(ang)*player.r*1.6); ctx.stroke();
  ctx.restore();

  // Parçacıklar
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i]; p.life-=1/60;
    ctx.globalAlpha = Math.max(0,p.life*2);
    ctx.fillStyle=p.color; ctx.fillRect(p.x-2*dpr,p.y-2*dpr,4*dpr,4*dpr);
    if(p.life<=0) particles.splice(i,1);
    ctx.globalAlpha=1;
  }

  // Sol üst HUD (oyun genel)
  const pad=10*dpr; ctx.font = `${14*dpr}px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif`;
  ctx.fillStyle=getCSS('--ink');
  ctx.fillText(`Skor: ${Math.floor(player.score).toLocaleString('tr-TR')}`, pad, 20*dpr);
  ctx.fillText(`Çarpan: x${player.mult.toFixed(1)}`, pad, 38*dpr);
  ctx.fillText(`Shard: ${player.shards}`, pad, 56*dpr);

  // HP bar
  const barW=160*dpr, barH=10*dpr;
  const hpR= clamp(player.hp/player.hpMax,0,1);
  ctx.fillStyle='#1d2230'; ctx.fillRect(pad, 66*dpr, barW, barH);
  ctx.fillStyle=getCSS('--acc1'); ctx.fillRect(pad, 66*dpr, barW*hpR, barH);

  // Safe radius gösterge
  ctx.fillStyle=getCSS('--ink-dim');
  ctx.fillText(`Güvenli Alan: ${(params.safeRadius/dpr|0)} px`, pad, 92*dpr);
}

/* =========  Bariyer HUD Güncelleme ========= */
function updateBarrierHUD(){
  const b = getLastBarrier();
  let hpRatio = 0, hpText = '—';
  if(b){
    hpRatio = clamp(b.hp/b.hpMax,0,1);
    hpText = Math.round(hpRatio*100)+'%';
  }
  bhpBar.style.width = (hpRatio*100).toFixed(1)+'%';
  bhpTxt.textContent = hpText;

  const cdRatio = barrier.cd>0 ? (1 - barrier.cd/barrier.cdMax) : 1;
  bcdBar.style.width = (cdRatio*100).toFixed(1)+'%';
  bcdTxt.textContent = barrier.cd>0 ? `${barrier.cd.toFixed(1)} sn` : 'Hazır';

  shardTxt.textContent = String(player.shards);
}

/* =========  Döngü  ========= */
function loop(){
  const t=now(); let dt=(t-tPrev)/1000; tPrev=t;
  dt = Math.min(dt, 0.033); // spike clamp

  if(state===State.PLAY) step(dt);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* =========  Kısayollar  ========= */
addEventListener('visibilitychange',()=>{ if(document.hidden && state===State.PLAY){state=State.PAUSE; menuEl.style.display='';}});
addEventListener('blur',()=>{ if(state===State.PLAY){state=State.PAUSE; menuEl.style.display='';}});
canvas.addEventListener('click',()=>audio.resume(),{once:true});
document.addEventListener('keydown',e=>{
  if(e.key.toLowerCase()==='m'){ muted=!muted; }
});

})();
</script>
</body>
</html>
